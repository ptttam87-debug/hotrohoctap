<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathpro - H·ªá Th·ªëng H·ªçc & Thi</title>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f3f4f6; --txt: #1f2937; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--txt); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* 1. AUTH */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .auth-card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 360px; text-align: center; border: 1px solid #ddd; }
        .inp { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .btn { padding: 10px 20px; background: var(--p); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:hover { opacity: 0.9; } .btn:active { transform: scale(0.95); }
        .btn-outline { background: white; color: #333; border: 1px solid #ccc; width: 100%; margin-top: 10px; }
        .tab-grp { display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 10px; cursor: pointer; background: none; border: none; font-weight: bold; color: #666; }
        .tab.active { color: var(--p); border-bottom: 3px solid var(--p); }
        .f-view { display: none; } .f-view.active { display: block; }

        /* 2. HEADER & NAV */
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 100; flex-shrink: 0; }
        .nav-bar { display: flex; justify-content: center; gap: 10px; padding: 10px; background: #fff; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .nav-btn { padding: 8px 16px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer; font-weight: 600; color: #666; }
        .nav-btn.active { background: var(--p); color: white; }

        /* 3. MAIN LAYOUT */
        #main-app { display: none; flex-direction: column; height: 100%; }
        .container { flex: 1; overflow-y: auto; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .section { display: none; height: 100%; } 
        .section.active { display: block; }

        /* 4. GIAO DI·ªÜN B√ÄI GI·∫¢NG E-LEARNING */
        .lecture-layout { display: flex; gap: 20px; height: 100%; flex-wrap: wrap; }
        .lecture-list { flex: 1; min-width: 250px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; overflow-y: auto; max-height: calc(100vh - 180px); }
        .lecture-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .lecture-item:hover { background: #f9fafb; color: var(--p); }
        .lecture-item.active { background: #eff6ff; color: var(--p); font-weight: bold; border-left: 4px solid var(--p); }
        .lecture-icon { margin-right: 10px; font-size: 1.1rem; }
        .lecture-viewer { flex: 3; min-width: 300px; background: #000; border-radius: 8px; overflow: hidden; height: 100%; min-height: 400px; position: relative; }
        .lecture-iframe { width: 100%; height: 100%; border: none; }
        .lecture-placeholder { display: flex; justify-content: center; align-items: center; height: 100%; color: white; flex-direction: column; }

        /* 5. GIAO DI·ªÜN THI (QUIZ) */
        .q-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 300px; display: flex; flex-direction: column; justify-content: center; font-family: 'Times New Roman', serif; font-size: 1.15rem; line-height: 1.5; }
        .part-label { background: #dbeafe; color: #1e40af; padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; display: inline-block; margin-bottom: 15px; font-family: 'Segoe UI', sans-serif; }
        .q-img { display: block; max-width: 100%; height: auto; max-height: 250px; margin: 15px auto; border: 1px solid #eee; border-radius: 8px; }
        
        /* Options P1 */
        .opt-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .opt-item { padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: 0.2s; font-family: 'Segoe UI', sans-serif; font-size: 1rem; }
        .opt-item:hover { background: #f9fafb; border-color: var(--p); }
        .opt-item.selected { background: #eff6ff; border-color: var(--p); color: var(--p); font-weight: bold; }
        
        /* Options P2 */
        .tf-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .tf-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .tf-btn { padding: 5px 15px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; margin-left: 5px; font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; }
        .tf-btn.selected { background: var(--p); color: white; border-color: var(--p); }

        /* Options P3 */
        .short-inp { width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-top: 10px; box-sizing: border-box; }
        .short-inp:focus { border-color: var(--p); outline: none; }

        /* FOOTER NAV */
        .footer-nav { background: white; padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #grid-panel { position: absolute; bottom: 70px; left: 0; right: 0; background: white; padding: 20px; border-top: 1px solid #ccc; display: none; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); max-height: 60vh; overflow-y: auto; z-index: 50; }
        .grid-sec-title { font-weight: bold; margin: 10px 0 5px 0; color: #666; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 5px; font-family: 'Segoe UI', sans-serif; }
        .grid-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .q-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 13px; display: flex; justify-content: center; align-items: center; }
        .q-btn.done { background: #22c55e; color: white; border-color: #22c55e; }
        .q-btn.current { border: 2px solid var(--p); font-weight: bold; transform: scale(1.1); }

        /* CHATBOT */
        .chat-btn { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: var(--p); border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 900; }
        .chat-box { position: fixed; bottom: 150px; right: 20px; width: 320px; height: 400px; background: white; border-radius: 12px; box-shadow: 0 5px 30px rgba(0,0,0,0.15); display: none; flex-direction: column; z-index: 900; border: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-card">
            <h2 style="color:var(--p);margin-top:0">Mathpro</h2>
            <div class="tab-grp">
                <button class="tab active" onclick="switchTab('login')">ƒêƒÉng Nh·∫≠p</button>
                <button class="tab" onclick="switchTab('reg')">ƒêƒÉng K√Ω</button>
            </div>
            <div id="v-login" class="f-view active">
                <input id="l-email" class="inp" placeholder="Email" value="hocsinh@mathpro.edu.vn">
                <input id="l-pass" type="password" class="inp" placeholder="M·∫≠t kh·∫©u" value="123456">
                <button class="btn" style="width:100%" onclick="doLogin()">V√†o L·ªõp</button>
            </div>
            <div id="v-reg" class="f-view">
                <input id="r-name" class="inp" placeholder="H·ªç t√™n">
                <input id="r-email" class="inp" placeholder="Email">
                <input id="r-pass" type="password" class="inp" placeholder="M·∫≠t kh·∫©u">
                <button class="btn" style="width:100%;background:#16a34a" onclick="doRegister()">T·∫°o T√†i Kho·∫£n</button>
            </div>
            <button class="btn btn-outline" onclick="doGoogle()">Google Login</button>
        </div>
    </div>

    <div id="main-app">
        <header>
            <strong style="font-size:1.3rem;color:var(--p)">Mathpro</strong>
            <div><span id="u-name" style="font-weight:bold;margin-right:10px">H·ªçc sinh</span><button class="btn" style="background:#fee2e2;color:red;padding:5px 10px" onclick="doLogout()">Tho√°t</button></div>
        </header>

        <div class="nav-bar">
            <button class="nav-btn active" onclick="nav('lecture')">B√†i Gi·∫£ng</button>
            <button class="nav-btn" onclick="nav('docs')">T√†i Li·ªáu</button>
            <button class="nav-btn" onclick="nav('quiz')">V√†o Thi</button>
        </div>

        <div class="container">
            
            <div id="sec-lecture" class="section active">
                <div class="card" style="height:100%; box-sizing:border-box; display:flex; flex-direction:column;">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">üì∫ Kho B√†i Gi·∫£ng</h3>
                    <div class="lecture-layout">
                        <div class="lecture-list" id="lecture-list"></div>
                        <div class="lecture-viewer">
                            <iframe id="main-frame" class="lecture-iframe" src="" allowfullscreen></iframe>
                            <div id="viewer-placeholder" class="lecture-placeholder">
                                <div style="font-size:3rem;">‚ñ∂Ô∏è</div>
                                <p>Ch·ªçn b√†i gi·∫£ng ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sec-docs" class="section">
                <div class="card">
                    <h3>üìö Kho T√†i Li·ªáu</h3>
                    <div style="padding:15px;background:#eff6ff;border-left:4px solid var(--p); margin-bottom:10px;">
                        <b>üìÑ ƒê·ªÅ c∆∞∆°ng √în t·∫≠p Ch∆∞∆°ng 1.pdf</b><br>
                        <a href="#" style="color:var(--p);text-decoration:none">‚¨áÔ∏è T·∫£i xu·ªëng</a>
                    </div>
                    <div style="padding:15px;background:#fdf2f8;border-left:4px solid #db2777;">
                        <b>üìÑ B√†i t·∫≠p t·ª± luy·ªán (C√≥ ƒë√°p √°n).pdf</b><br>
                        <a href="#" style="color:#db2777;text-decoration:none">‚¨áÔ∏è T·∫£i xu·ªëng</a>
                    </div>
                </div>
            </div>

            <div id="sec-quiz" class="section" style="flex-direction:column">
                <div id="quiz-area" style="flex:1; display:flex; flex-direction:column; justify-content:center;"></div>
            </div>
        </div>

        <div id="footer-nav" class="footer-nav" style="display:none">
            <button class="btn" style="background:#e5e7eb;color:#333" onclick="moveQ(-1)">‚¨ÖÔ∏è Tr∆∞·ªõc</button>
            <button class="btn" style="background:white;color:var(--p);border:1px solid var(--p)" onclick="toggleGrid()">üî¢ Danh s√°ch c√¢u</button>
            <button class="btn" onclick="moveQ(1)">Sau ‚û°Ô∏è</button>
            <button class="btn" style="background:#dc2626;margin-left:10px" onclick="submitExam()">N·ªòP B√ÄI</button>
        </div>
        
        <div id="grid-panel">
            <div class="grid-sec-title">PH·∫¶N I (12 C√¢u)</div> <div class="grid-row" id="grid-p1"></div>
            <div class="grid-sec-title">PH·∫¶N II (2 C√¢u)</div> <div class="grid-row" id="grid-p2"></div>
            <div class="grid-sec-title">PH·∫¶N III (4 C√¢u)</div> <div class="grid-row" id="grid-p3"></div>
        </div>
    </div>

    <div class="chat-btn" onclick="toggleChat()">üí¨</div>
    <div class="chat-box" id="chat-box">
        <div style="padding:10px;background:var(--p);color:white;font-weight:bold">Tr·ª£ l√Ω AI</div>
        <div style="flex:1;padding:10px;overflow-y:auto;background:#f9f9f9" id="chat-msgs"><div class="msg bot">Ch√†o em!</div></div>
        <div style="padding:10px;border-top:1px solid #eee;display:flex"><input id="chat-inp" class="inp" style="margin:0;flex:1"><button class="btn" style="margin-left:5px" onclick="sendChat()">G·ª≠i</button></div>
    </div>

    <script>
        const CFG={apiKey:"AIzaSyC1RdQm6whSY6afs5ueEXYaBl6E31oIcS0",authDomain:"mathpro-db.firebaseapp.com",projectId:"mathpro-db"};
        const GEMINI="AIzaSyBKWlAMRP32ubiF3WoLQR57z3RamEhlJy0";
        const SHEET="https://script.google.com/macros/s/AKfycbz4rTGYlQhHLZTUMyVlY5Tlcrv81k0UfhEMy_B-62GYfEJTM4s7JCq-ANEm3ofn0QdONA/exec";
        let auth, user, currentQ=0, answers={};

        // --- D·ªÆ LI·ªÜU B√ÄI GI·∫¢NG ---
        const LECTURES = [
            { id: 1, title: "B√†i 1: Nguy√™n h√†m c∆° b·∫£n (Video)", type: "video", url: "https://www.youtube.com/embed/JzHbWqV2q2E" },
            { id: 2, title: "B√†i 2: Ph∆∞∆°ng ph√°p ƒë·ªïi bi·∫øn s·ªë (Slide)", type: "slide", url: "https://docs.google.com/presentation/d/e/2PACX-1vQ.../embed" },
            { id: 3, title: "B√†i 1: T√≠nh ƒë∆°n ƒëi·ªáu c·ªßa h√†m s·ªë (E-learning)", type: "elearning", url: "baigiang-bai1/index.html" }
        ];

        // --- D·ªÆ LI·ªÜU C√ÇU H·ªéI (CHU·∫®N 100%) ---
        const QUESTIONS = [
            // P1 (12 c√¢u)
            {type:1, id:1, q:`Cho t·ª© di·ªán ABCD, g·ªçi I, J l·∫ßn l∆∞·ª£t l√† trung ƒëi·ªÉm c·ªßa AB v√† CD. ƒê·∫≥ng th·ª©c n√†o sau ƒë√¢y sai? <img src="img/c1.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{AC}+\\vec{BD})\\)", "B. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{DC}+\\vec{AD}+\\vec{BD})\\)", "C. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{AD}+\\vec{BC})\\)", "D. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{AC}+\\vec{BD})\\)"], a:"B"},
            {type:1, id:2, q:`H√†m s·ªë c√≥ ƒë·ªì th·ªã nh∆∞ h√¨nh v·∫Ω sau ƒë·ªìng bi·∫øn tr√™n kho·∫£ng n√†o d∆∞·ªõi ƒë√¢y? <img src="img/c2.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. (-3; 1)", "B. (-1; 1)", "C. (1; +‚àû)", "D. (-1; +‚àû)"], a:"B"},
            {type:1, id:3, q:"Cho h√†m s·ªë \\(y=\\frac{x-1}{x+1}\\). Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y ƒë√∫ng?", opts:["A. ƒê·ªìng bi·∫øn tr√™n R\\{-1}", "B. Ngh·ªãch bi·∫øn tr√™n R\\{-1}", "C. ƒê·ªìng bi·∫øn (-‚àû;-1)U(-1;+‚àû)", "D. ƒê·ªìng bi·∫øn t·ª´ng kho·∫£ng"], a:"D"},
            {type:1, id:4, q:"H√†m s·ªë \\(y=\\ln(4-x^2)\\) ƒë·ªìng bi·∫øn tr√™n kho·∫£ng?", opts:["A. (-2; 2)", "B. (-2; 0)", "C. (0; 2)", "D. (-‚àû; 2)"], a:"B"},
            {type:1, id:5, q:`Cho h√†m s·ªë y=f(x) c√≥ b·∫£ng bi·∫øn thi√™n. M·ªánh ƒë·ªÅ n√†o sai? <img src="img/c5.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. Ngh·ªãch bi·∫øn (-‚àû; 2)", "B. ƒê·ªìng bi·∫øn (2; +‚àû)", "C. ƒê·ªìng bi·∫øn (2; 5)", "D. Ngh·ªãch bi·∫øn (0; 2)"], a:"A"},
            {type:1, id:6, q:`Cho h√¨nh h·ªôp ABCD.A'B'C'D'. T√≠nh t·ªïng \\(\\vec{AB}+\\vec{AD}+\\vec{A'C'}\\) <img src="img/c6.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. \\(2\\vec{AA'}\\)", "B. \\(2\\vec{AC}\\)", "C. \\(2\\vec{C'A'}\\)", "D. \\(\\vec{0}\\)"], a:"B"},
            {type:1, id:7, q:"Cho h√¨nh l·∫≠p ph∆∞∆°ng ABCD.A'B'C'D'. Kh·∫≥ng ƒë·ªãnh n√†o sai?", opts:["A. (AB,A'D')=90", "B. (AB,A'C')=45", "C. (AC,B'D')=90", "D. (A'A,CB')=45"], a:"D"},
            {type:1, id:8, q:"Cho h√†m s·ªë y=f(x) li√™n t·ª•c tr√™n R c√≥ ƒë·∫°o h√†m \\(f'(x)=x(1-x)^2(x-2)^3\\). Ngh·ªãch bi·∫øn tr√™n?", opts:["A. (0; 2)", "B. (-‚àû; 0)", "C. (1; +‚àû)", "D. (-1; 1)"], a:"A"},
            {type:1, id:9, q:"T√¨m kho·∫£ng ngh·ªãch bi·∫øn c·ªßa h√†m s·ªë bi·∫øt \\(f'(x)=3x(x-1)^2(x+2)^3\\).", opts:["A. (-2;0) v√† (1;+‚àû)", "B. (-‚àû;-2) v√† (0;1)", "C. (-‚àû;-2) v√† (0;+‚àû)", "D. (-2; 0)"], a:"D"},
            {type:1, id:10, q:"Gi·∫£ s·ª≠ l∆∞·ª£ng h√†ng b√°n ra x theo gi√° p l√† \\(x=\\frac{250-p}{0.01p}\\). Kh·∫≥ng ƒë·ªãnh ƒë√∫ng?", opts:["A. TƒÉng khi gi√° tƒÉng", "B. Gi·∫£m khi gi√° gi·∫£m", "C. Ko ƒë·ªïi", "D. Gi·∫£m khi gi√° tƒÉng"], a:"D"},
            {type:1, id:11, q:`V·∫≠n t·ªëc ch·∫•t ƒëi·ªÉm tƒÉng khi t thu·ªôc kho·∫£ng n√†o? <img src="img/c11.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. (-3; +‚àû)", "B. (0; 2)", "C. (2; +‚àû)", "D. (0; +‚àû)"], a:"C"},
            {type:1, id:12, q:`H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n kho·∫£ng n√†o? <img src="img/c12.png" class="q-img" onerror="this.style.display='none'">`, opts:["A. (0; 1)", "B. (-‚àû; 4)", "C. (-1; 0)", "D. (1; +‚àû)"], a:"A"},
            // P2 (2 c√¢u)
            {type:2, id:13, q:"Trong kh√¥ng gian, cho hai vect∆° a v√† b c√πng c√≥ ƒë·ªô d√†i b·∫±ng 1, g√≥c 45 ƒë·ªô.", subs:["a) \\(\\vec{a}.\\vec{b}=\\frac{\\sqrt{2}}{2}\\).", "b) \\(|\\vec{a}+\\vec{b}|=2+\\sqrt{2}\\).", "c) \\((\\vec{a}+3\\vec{b}).(\\vec{a}-2\\vec{b})=-5+\\frac{\\sqrt{2}}{2}\\).", "d) \\(|\\vec{a}-\\sqrt{2}\\vec{b}|=0\\)."], ans:["S","S","ƒê","ƒê"]},
            {type:2, id:14, q:"X√©t h√†m s·ªë \\(y=\\frac{1}{3}x^3+(m+1)x^2+(m^2+2m)x-3\\) m l√† tham s·ªë.", subs:["a) H√†m s·ªë ngh·ªãch bi·∫øn tr√™n \\(\\mathbb{R}\\) v·ªõi m·ªçi gi√° tr·ªã c·ªßa m.", "b) H√†m s·ªë ngh·ªãch bi·∫øn tr√™n kho·∫£ng (-1; 1) khi v√† ch·ªâ khi \\(m \\ge -1\\).", "c) Kh√¥ng t·ªìn t·∫°i gi√° tr·ªã m ƒë·ªÉ h√†m s·ªë ƒë·ªìng bi·∫øn tr√™n \\(\\mathbb{R}\\).", "d) T·∫≠p x√°c ƒë·ªãnh c·ªßa h√†m s·ªë l√† \\(D=\\mathbb{R}\\setminus\\{3\\}\\)."], ans:["S","S","ƒê","S"]},
            // P3 (4 c√¢u)
            {type:3, id:15, q:`H·∫±ng ng√†y m·ª±c n∆∞·ªõc c·ªßa m·ªôt con k√™nh l√™n xu·ªëng theo th·ªßy tri·ªÅu. ƒê·ªô s√¢u h (m) c·ªßa m·ª±c n∆∞·ªõc trong k√™nh t·∫°i th·ªùi ƒëi·ªÉm \\(t(h)(0\\le t\\le24)\\) trong ng√†y ƒë∆∞·ª£c x√°c ƒë·ªãnh b·ªüi c√¥ng th·ª©c \\(h=2\\cos(\\frac{\\pi t}{12}+\\frac{\\pi}{3})+5\\). G·ªçi (a;b) l√† kho·∫£ng th·ªùi gian trong ng√†y m√† ƒë·ªô s√¢u c·ªßa m·ª±c n∆∞·ªõc trong k√™nh tƒÉng d·∫ßn. T√≠nh gi√° tr·ªã c·ªßa \\(a+b\\).`, a:"28"},
            {type:3, id:16, q:`Ng∆∞·ªùi ta v·∫≠n chuy·ªÉn m·ªôt th√πng h√†ng c√≥ d·∫°ng h√¨nh h·ªôp ch·ªØ nh·∫≠t b·∫±ng c√°ch m√≥c 4 d√¢y c√°p v√†o 4 g√≥c tr√™n c·ªßa th√πng h√†ng v√† ƒë·∫ßu c√≤n l·∫°i m√≥c v√†o c·∫ßn c·∫©u nh∆∞ h√¨nh v·∫Ω. <img src="img/p3c2.png" class="q-img" onerror="this.style.display='none'"> Bi·∫øt r·∫±ng c√°c ƒëo·∫°n d√¢y c√°p c√≥ ƒë·ªô d√†i b·∫±ng nhau v√† g√≥c t·∫°o b·ªüi hai ƒëo·∫°n d√¢y c√°p ƒë·ªëi di·ªán nhau l√† \\(60^{\\circ}\\). Chi·∫øc c·∫ßn c·∫©u k√©o th√πng h√†ng l√™n theo ph∆∞∆°ng th·∫≥ng ƒë·ª©ng. Bi·∫øt r·∫±ng \\(F_{1}, F_{2}, F_{3}, F_{4}\\) ch·ªãu ƒë∆∞·ª£c t·ªëi ƒëa l·ª±c cƒÉng l√† 5 000 N. H·ªèi c·∫ßn c·∫©u n√¢ng ƒë∆∞·ª£c th√πng h√†ng c√≥ kh·ªëi l∆∞·ª£ng (ƒë∆°n v·ªã kg) t·ªëi ƒëa l√† bao nhi√™u (l√†m tr√≤n ƒë·∫øn h√†ng ƒë∆°n v·ªã)? L·∫•y \\(g=10~m/s^{2}\\).`, a:"1732"},
            {type:3, id:17, q:`Cho h√†m s·ªë \\(f(x)=x^{2}-2x\\). ƒê·∫∑t \\(g(x)=f(f(x))+1\\). Gi·∫£ s·ª≠ h√†m s·ªë \\(y=g(x)\\) ƒë·ªìng bi·∫øn tr√™n kho·∫£ng (a;b) v·ªõi \\(a\\in\\mathbb{R}, b\\in\\mathbb{R}\\). T√≠nh \\(a+b\\sqrt{2}\\).`, a:"1"},
            {type:3, id:18, q:`Th·ªÉ t√≠ch \\(V(cm^{3})\\) c·ªßa 1kg n∆∞·ªõc t·∫°i nhi·ªát ƒë·ªô \\(T(0^{\\circ}C\\le T\\le30^{\\circ}C)\\) ƒë∆∞·ª£c t√≠nh b·ªüi c√¥ng th·ª©c \\(V(T)=999,87-0,06426T+0,0058043T^{2}-0,0000679T^{3}.\\) Th·ªÉ t√≠ch n∆∞·ªõc \\(V(T)(0^{\\circ}C\\le T\\le30^{\\circ}C)\\) gi·∫£m trong kho·∫£ng nhi·ªát ƒë·ªô \\((a^{\\circ};b^{\\circ});\\) b l√†m tr√≤n ƒë·∫øn h√†ng ƒë∆°n v·ªã. T·ªïng \\(a+b\\) b·∫±ng bao nhi√™u?`, a:"4"}
        ];

        // LOGIC AUTH
        function switchTab(t){
            document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.f-view').forEach(f=>f.classList.remove('active'));
            if(t==='login'){document.querySelectorAll('.tab')[0].classList.add('active');document.getElementById('v-login').classList.add('active')}
            else{document.querySelectorAll('.tab')[1].classList.add('active');document.getElementById('v-reg').classList.add('active')}
        }
        function doLogin(){auth.signInWithEmailAndPassword(document.getElementById('l-email').value,document.getElementById('l-pass').value).catch(e=>alert(e.message))}
        function doRegister(){const n=document.getElementById('r-name').value;auth.createUserWithEmailAndPassword(document.getElementById('r-email').value,document.getElementById('r-pass').value).then(c=>c.user.updateProfile({displayName:n}).then(()=>location.reload())).catch(e=>alert(e.message))}
        function doGoogle(){auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message))}
        function doLogout(){auth.signOut().then(()=>location.reload())}
        
        // LOGIC NAV & LECTURE
        function nav(id){
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); // Reset
            
            const quizSec = document.getElementById('sec-quiz');
            if(id === 'quiz') {
                quizSec.classList.add('active');
                quizSec.style.display = 'flex'; // Force flex for slide layout
                document.getElementById('footer-nav').style.display='flex';
                renderQ();
            } else {
                quizSec.classList.remove('active');
                quizSec.style.display = 'none'; // Force hide
                document.getElementById('sec-'+id).classList.add('active');
                document.getElementById('footer-nav').style.display='none';
            }
            // Active btn
            const btnMap = {'lecture':0, 'docs':1, 'quiz':2};
            document.querySelectorAll('.nav-btn')[btnMap[id]].classList.add('active');
        }

        function initLectures() {
            const list = document.getElementById('lecture-list');
            if(!list) return;
            let html = '';
            LECTURES.forEach((lec, index) => {
                html += `<div class="lecture-item" onclick="playLecture(${index})" id="lec-btn-${index}">
                    <span class="lecture-icon">üì∫</span> <span>${lec.title}</span>
                </div>`;
            });
            list.innerHTML = html;
        }

        function playLecture(index) {
            document.querySelectorAll('.lecture-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`lec-btn-${index}`).classList.add('active');
            const lec = LECTURES[index];
            document.getElementById('viewer-placeholder').style.display = 'none';
            document.getElementById('main-frame').style.display = 'block';
            document.getElementById('main-frame').src = lec.url;
        }

        // LOGIC QUIZ
        function renderQ(){
            const q = QUESTIONS[currentQ];
            let html = `<div class="q-card">
                <div><span class="part-label">Ph·∫ßn ${q.type} - C√¢u ${q.id}</span></div>
                <div class="q-content">${q.q}</div>`;
            
            if(q.type === 1) { // P1
                html += `<div class="opt-list">`;
                q.opts.forEach(opt => {
                    const val = opt.charAt(0);
                    const sel = answers[q.id] === val ? 'selected' : '';
                    html += `<div class="opt-item ${sel}" onclick="saveAns(${q.id}, '${val}')">${opt}</div>`;
                });
                html += `</div>`;
            } else if(q.type === 2) { // P2
                html += `<table class="tf-table">`;
                q.subs.forEach((sub, idx) => {
                    const k = `${q.id}_${idx}`;
                    const dSel = answers[k] === 'ƒê' ? 'selected' : '';
                    const sSel = answers[k] === 'S' ? 'selected' : '';
                    html += `<tr><td>${sub}</td><td width="130">
                        <span class="tf-btn ${dSel}" onclick="saveAns('${k}', 'ƒê')">ƒê√∫ng</span>
                        <span class="tf-btn ${sSel}" onclick="saveAns('${k}', 'S')">Sai</span>
                    </td></tr>`;
                });
                html += `</table>`;
            } else { // P3
                const val = answers[q.id] || '';
                html += `<input class="short-inp" value="${val}" oninput="saveAns(${q.id}, this.value)" placeholder="Nh·∫≠p s·ªë...">`;
            }
            html += `</div>`;
            document.getElementById('quiz-area').innerHTML = html;
            if(window.MathJax) MathJax.typesetPromise();
            updateGrid();
        }

        function saveAns(key, val) {
            answers[key] = val;
            renderQ();
        }

        function moveQ(dir) {
            const next = currentQ + dir;
            if(next >= 0 && next < QUESTIONS.length) {
                currentQ = next;
                renderQ();
            }
        }

        function toggleGrid() {
            const p = document.getElementById('grid-panel');
            if(p.style.display === 'block') { p.style.display = 'none'; return; }
            
            const p1 = QUESTIONS.filter(q=>q.type===1).map((q,i) => renderBtn(q, i)).join('');
            const p2 = QUESTIONS.filter(q=>q.type===2).map((q,i) => renderBtn(q, i+12)).join(''); // offset 12
            const p3 = QUESTIONS.filter(q=>q.type===3).map((q,i) => renderBtn(q, i+14)).join(''); // offset 14

            document.getElementById('grid-p1').innerHTML = p1;
            document.getElementById('grid-p2').innerHTML = p2;
            document.getElementById('grid-p3').innerHTML = p3;
            p.style.display = 'block';
        }

        function renderBtn(q, idx) {
            let done = false;
            if(q.type===1 && answers[q.id]) done=true;
            if(q.type===3 && answers[q.id]) done=true;
            if(q.type===2) { // P2: L√†m √≠t nh·∫•t 1 √Ω l√† xanh
                for(let k=0; k<4; k++) if(answers[`${q.id}_${k}`]) done=true;
            }
            const cls = done ? 'done' : '';
            const cur = idx === currentQ ? 'current' : '';
            return `<button class="q-btn ${cls} ${cur}" onclick="currentQ=${idx};renderQ();toggleGrid()">${q.id}</button>`;
        }

        function submitExam() {
            let s1=0, s2=0, s3=0;
            QUESTIONS.filter(q=>q.type===1).forEach(q=>{ if(answers[q.id]===q.a) s1+=0.25; });
            QUESTIONS.filter(q=>q.type===2).forEach(q=>{
                let c=0;
                q.ans.forEach((ans, i)=>{ if(answers[`${q.id}_${i}`]===ans) c++; });
                s2 += [0, 0.1, 0.25, 1.0, 1.5][c];
            });
            QUESTIONS.filter(q=>q.type===3).forEach(q=>{ if(answers[q.id]?.trim()===q.a) s3+=1.0; });
            
            const total = (s1+s2+s3).toFixed(2);
            alert(`N·ªôp b√†i th√†nh c√¥ng!\nT·ªïng ƒëi·ªÉm: ${total}\n(P1: ${s1}, P2: ${s2}, P3: ${s3})`);
            const fd=new FormData(); fd.append("TenHocSinh",user.email); fd.append("Diem",total);
            fetch(SHEET,{method:'POST',body:fd});
        }

        // CHAT
        function toggleChat(){const b=document.getElementById('chat-box');b.style.display=b.style.display==='flex'?'none':'flex'}
        async function sendChat(){
            const i=document.getElementById('chat-inp'), t=i.value.trim(); if(!t)return;
            const b=document.getElementById('chat-msgs'); b.innerHTML+=`<div class="msg user">${t}</div>`; i.value=''; b.scrollTop=b.scrollHeight;
            try{
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:"Gi·∫£i ng·∫Øn: "+t}]}]})});
                const d = await r.json(); b.innerHTML+=`<div class="msg bot">${d.candidates[0].content.parts[0].text}</div>`;
            }catch(e){b.innerHTML+=`<div class="msg bot">L·ªói AI</div>`}
        }

        // INIT
        window.onload=()=>{
            try{
                firebase.initializeApp(CFG); auth=firebase.auth();
                auth.onAuthStateChanged(u=>{
                    if(u){
                        user=u;
                        document.getElementById('auth-overlay').style.display='none';
                        document.getElementById('main-app').style.display='flex';
                        document.getElementById('u-name').innerText=u.displayName||u.email;
                        initLectures();
                    } else {
                        document.getElementById('auth-overlay').style.display='flex';
                        document.getElementById('main-app').style.display='none';
                    }
                });
            }catch(e){alert("L·ªói: "+e.message)}
        };
    </script>
</body>
</html>