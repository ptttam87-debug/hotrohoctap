<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mathpro - H·ªá Th·ªëng H·ªçc & Thi (AI Powered)</title>
    
    <!-- C·∫•u h√¨nh MathJax -->
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      startup: {
        typeset: false
      }
    };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Firebase (Mock) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <!-- Marked Library for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --p: #2563eb; --bg: #f3f4f6; --txt: #1f2937; --success: #22c55e; --warning: #eab308; --danger: #ef4444; --ai: #8b5cf6; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; background: var(--bg); color: var(--txt); 
            height: 100vh; height: 100dvh; 
            display: flex; flex-direction: column; overflow: hidden; 
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* AUTH & MODAL */
        #auth-overlay, #info-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        #info-modal { background: rgba(0,0,0,0.8); z-index: 10000; display: none; }
        .auth-card, .modal-card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 360px; text-align: center; border: 1px solid #ddd; }
        .inp { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .btn { padding: 12px 20px; background: var(--p); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; width: 100%; margin-top: 10px; }
        .btn:hover { opacity: 0.9; } .btn:active { transform: scale(0.95); }
        .google-btn { display: flex; align-items: center; justify-content: center; background: white; border: 1px solid #ccc; color: #333; margin-top: 15px; }
        .g-icon { width: 18px; height: 18px; margin-right: 10px; }
        .tab-grp { display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 10px; cursor: pointer; background: none; border: none; font-weight: bold; color: #666; }
        .tab.active { color: var(--p); border-bottom: 3px solid var(--p); }
        .f-view { display: none; } .f-view.active { display: block; }

        /* K·∫æT QU·∫¢ THI */
        #result-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 11000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .result-card { background: white; width: 90%; max-width: 420px; padding: 40px 30px; border-radius: 24px; text-align: center; position: relative; animation: popUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 30px 60px rgba(0,0,0,0.5); }
        .result-card::before { content: ''; position: absolute; inset: -5px; z-index: -1; background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000); border-radius: 28px; background-size: 400%; animation: glow 20s linear infinite; }
        .result-card::after { content: ''; position: absolute; inset: 0; background: white; border-radius: 24px; z-index: -1; }
        @keyframes glow { 0% { background-position: 0 0; } 50% { background-position: 400% 0; } 100% { background-position: 0 0; } }
        @keyframes popUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-20px);} 60% {transform: translateY(-10px);} }
        .res-icon { font-size: 80px; margin-bottom: 10px; display: inline-block; animation: bounce 2s infinite; text-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .res-title { font-size: 1.2rem; color: #666; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .res-score { font-size: 4.5rem; font-weight: 800; background: linear-gradient(to right, #2563eb, #db2777); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 5px 0; line-height: 1; }
        .res-time { font-size: 1.1rem; color: #555; background: #f3f4f6; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-bottom: 20px; font-weight: 600; }
        .res-msg { font-size: 1.1rem; color: #333; margin-bottom: 30px; line-height: 1.5; font-weight: 500; }
        .res-btn { background: linear-gradient(135deg, #2563eb, #06b6d4); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3); width: 100%; }
        .res-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(37, 99, 235, 0.5); filter: brightness(1.1); }

        /* HEADER & NAV */
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 100; flex-shrink: 0; }
        .nav-bar { display: flex; justify-content: center; gap: 10px; padding: 10px; background: #fff; border-bottom: 1px solid #eee; flex-shrink: 0; overflow-x: auto; }
        .nav-btn { padding: 8px 16px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer; font-weight: 600; color: #666; width: auto; margin-top: 0; white-space: nowrap; }
        .nav-btn.active { background: var(--p); color: white; }

        /* LAYOUT */
        #main-app { display: none; flex-direction: column; height: 100%; }
        .container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; -webkit-overflow-scrolling: touch; }
        .section { display: none; height: 100%; } .section.active { display: block; }

        /* PROFILE */
        .profile-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .score-badge { padding: 4px 10px; border-radius: 12px; font-weight: bold; color: white; font-size: 0.9rem; }
        .s-low { background: var(--danger); } .s-mid { background: var(--warning); } .s-high { background: var(--success); }

        /* QUIZ & TOP 10 */
        .quiz-layout { display: flex; gap: 20px; height: 100%; flex-wrap: wrap; }
        .quiz-main { flex: 3; display: flex; flex-direction: column; min-width: 300px; }
        .quiz-sidebar { flex: 1; background: white; border-radius: 12px; padding: 15px; border: 1px solid #eee; height: fit-content; min-width: 250px; }
        .paper-header { background: #fff; border: 2px solid #000; padding: 15px; margin-bottom: 20px; font-family: 'Times New Roman', serif; display: flex; justify-content: space-between; align-items: flex-start; }
        .paper-info div { margin-bottom: 5px; font-size: 1.1rem; }
        
        #timer-box { font-size: 1.5rem; font-weight: bold; color: #2563eb; border: 2px solid #2563eb; padding: 5px 15px; border-radius: 8px; display: inline-block; margin-bottom: 5px; min-width: 100px; text-align: center; }
        .status-box { text-align: right; }

        .top-list { list-style: none; padding: 0; margin: 0; }
        .top-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; align-items: center; }
        .top-rank { font-weight: bold; width: 25px; display: inline-block; }
        .top-1 { color: #eab308; } .top-2 { color: #94a3b8; } .top-3 { color: #b45309; }
        .top-time { font-size: 0.75rem; color: #666; margin-left: 5px; }

        /* QUESTION CARD & HINT */
        .q-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 300px; display: flex; flex-direction: column; justify-content: center; font-family: 'Times New Roman', serif; font-size: 1.15rem; line-height: 1.5; }
        .part-label { font-family: 'Segoe UI', sans-serif; background: #dbeafe; color: #1e40af; padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; display: inline-block; margin-bottom: 15px; }
        .q-img { display: block; max-width: 100%; height: auto; max-height: 250px; margin: 15px auto; border: 1px solid #eee; border-radius: 8px; }
        .opt-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .opt-item { font-family: 'Segoe UI', sans-serif; font-size: 1rem; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .opt-item:hover { background: #f9fafb; border-color: var(--p); }
        .opt-item.selected { background: #eff6ff; border-color: var(--p); color: var(--p); font-weight: bold; }
        .review-correct { background: #dcfce7 !important; border-color: #22c55e !important; color: #15803d !important; }
        .review-wrong { background: #fee2e2 !important; border-color: #ef4444 !important; color: #b91c1c !important; }
        .tf-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-family: 'Segoe UI', sans-serif; font-size: 1rem; }
        .tf-table td { padding: 8px 0; border-bottom: 1px dashed #eee; }
        .tf-btn { padding: 5px 15px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        .tf-btn.selected { background: var(--p); color: white; border-color: var(--p); }
        .short-inp { width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-top: 10px; box-sizing: border-box; }

        /* HINT BOX */
        .hint-box { 
            background: #fef9c3; 
            border: 1px dashed #eab308; 
            padding: 15px; 
            margin-top: 20px; 
            border-radius: 8px; 
            display: none; 
            color: #854d0e; 
            font-size: 1rem;
            font-family: 'Segoe UI', sans-serif;
            animation: fadeIn 0.3s;
        }
        .hint-toggle-btn {
            background: white;
            border: 1px solid #eab308;
            color: #d97706;
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .hint-toggle-btn:hover { background: #fef9c3; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* FOOTER */
        .footer-nav { 
            background: white; 
            padding: 15px; 
            border-top: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0;
            padding-bottom: calc(15px + env(safe-area-inset-bottom)); 
        }
        #grid-panel { position: absolute; bottom: 80px; left: 0; right: 0; background: white; padding: 20px; border-top: 1px solid #ccc; display: none; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); max-height: 60vh; overflow-y: auto; z-index: 50; padding-bottom: 40px; }
        .grid-sec-title { font-weight: bold; margin: 10px 0 5px 0; color: #666; font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 5px; font-family: 'Segoe UI', sans-serif; }
        .grid-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .q-btn { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 13px; display: flex; justify-content: center; align-items: center; }
        .q-btn.done { background: var(--success); color: white; border-color: var(--success); }
        .q-btn.current { border: 2px solid var(--p); font-weight: bold; transform: scale(1.1); }

        /* E-LEARNING & INFO */
        .lecture-layout { display: flex; gap: 20px; height: 100%; flex-wrap: wrap; }
        .lecture-list { flex: 1; min-width: 250px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; overflow-y: auto; max-height: calc(100vh - 180px); }
        .lecture-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .lecture-item.active { background: #eff6ff; color: var(--p); font-weight: bold; border-left: 4px solid var(--p); }
        
        .lecture-viewer { flex: 3; min-width: 300px; background: #000; border-radius: 8px; overflow: hidden; height: 100%; min-height: 400px; position: relative; }
        .lecture-viewer.fullscreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; border-radius: 0; }
        
        .lecture-iframe { width: 100%; height: 100%; border: none; }
        
        #fullscreen-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; z-index: 10; display: none; }
        #fullscreen-btn:hover { background: rgba(0,0,0,0.8); }

        .doc-section { margin-bottom: 20px; }
        .doc-header { font-size: 1.2rem; font-weight: bold; border-bottom: 2px solid var(--p); padding-bottom: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: var(--txt); }
        .chapter-title { font-weight: bold; font-size: 1.1rem; color: #1e40af; margin: 15px 0 10px 0; background: #dbeafe; padding: 10px 15px; border-radius: 6px; border-left: 4px solid #1e40af; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .chapter-title:hover { background: #bfdbfe; }
        .info-grid { display: none; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; padding: 10px 0; }
        .info-grid.show { display: grid; }
        .info-card { background: white; border: 1px solid #eee; border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.3s; }
        .info-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: var(--p); }
        .info-img { width: 100%; height: 140px; object-fit: cover; }
        .info-title { padding: 10px; font-weight: 600; font-size: 0.9rem; text-align: center; }
        
        /* LIGHTBOX & PDF MODAL */
        #lightbox, #pdf-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #lightbox img { max-width: 90%; max-height: 80vh; border-radius: 4px; }
        
        .pdf-container { width: 90%; height: 90%; background: white; border-radius: 8px; position: relative; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .pdf-header { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; background: #f9fafb; border-radius: 8px 8px 0 0; }
        .pdf-frame { flex: 1; width: 100%; border: none; border-radius: 0 0 8px 8px; }

        /* CHATBOT UI */
        .chat-btn { position: fixed; bottom: 120px; right: 20px; width: 50px; height: 50px; background: linear-gradient(135deg, var(--p), var(--ai)); border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 900; }
        .chat-box { position: fixed; bottom: 180px; right: 20px; width: 340px; height: 450px; background: white; border-radius: 12px; box-shadow: 0 5px 30px rgba(0,0,0,0.15); display: none; flex-direction: column; z-index: 900; border: 1px solid #eee; }
        
        .chat-preview-area { padding: 0 10px; display: none; flex-wrap: wrap; gap: 5px; background: #f9f9f9; border-bottom: 1px solid #eee; }
        .chat-file-preview { background: #e0f2fe; border-radius: 4px; padding: 4px 8px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; color: var(--p); margin: 5px 0; max-width: 100%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .preview-thumb { width: 30px; height: 30px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; }
        
        /* AI BUTTONS */
        .ai-btn { background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899); color: white; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; margin-top: 10px; }
        .ai-btn:hover { filter: brightness(1.1); transform: scale(1.02); }

        @media (max-width: 768px) {
            .lecture-layout { flex-direction: column; }
            .lecture-viewer { min-height: 250px; }
            .quiz-layout { flex-direction: column; }
            .quiz-sidebar { order: -1; }
        }
    </style>
</head>
<body>

    <div id="result-modal">
        <div class="result-card">
            <div class="res-icon">üèÜ</div>
            <div class="res-title">K·∫øt Qu·∫£ B√†i Thi</div>
            <div class="res-score" id="res-score">0.0</div>
            <div class="res-time" id="res-time">‚è± 00p 00s</div>
            <div class="res-msg" id="res-msg">L·ªùi nh·∫Øn...</div>
            <button class="res-btn" onclick="closeResult()">Xem Chi Ti·∫øt & Gi·∫£i</button>
        </div>
    </div>

    <div id="auth-overlay">
        <div class="auth-card">
            <h2 style="color:var(--p);margin-top:0">Mathpro</h2>
            <div class="tab-grp">
                <button class="tab active" onclick="switchTab('login')">ƒêƒÉng Nh·∫≠p</button>
                <button class="tab" onclick="switchTab('reg')">ƒêƒÉng K√Ω</button>
            </div>
            <div id="v-login" class="f-view active">
                <input id="l-email" class="inp" placeholder="Email" value="demo@mathpro.edu.vn">
                <input id="l-pass" type="password" class="inp" placeholder="M·∫≠t kh·∫©u" value="123456">
                <button class="btn" onclick="doFakeLogin()">V√†o L·ªõp Ngay (Demo)</button>
            </div>
            <div id="v-reg" class="f-view">
                <input id="r-name" class="inp" placeholder="H·ªç t√™n">
                <input id="r-email" class="inp" placeholder="Email">
                <input id="r-pass" type="password" class="inp" placeholder="M·∫≠t kh·∫©u">
                <button class="btn" style="background:#16a34a" onclick="doFakeLogin()">T·∫°o T√†i Kho·∫£n Demo</button>
            </div>
            <button class="btn google-btn" onclick="doFakeLogin()">
                <svg class="g-icon" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg> Ti·∫øp t·ª•c v·ªõi Google
            </button>
            <p style="font-size:0.8rem; color:#666; margin-top:10px">L∆∞u √Ω: Ch·∫ø ƒë·ªô demo kh√¥ng y√™u c·∫ßu m·∫≠t kh·∫©u th·ª±c.</p>
        </div>
    </div>

    <div id="info-modal">
        <div class="modal-card">
            <h3 style="color:var(--p)">C·∫≠p Nh·∫≠t Th√¥ng Tin</h3>
            <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">Vui l√≤ng nh·∫≠p t√™n v√† l·ªõp ƒë·ªÉ ghi nh·∫≠n ƒëi·ªÉm thi.</p>
            <input id="u-fullname" class="inp" placeholder="H·ªç v√† t√™n (VD: Nguy·ªÖn VƒÉn A)" value="B·∫°n H·ªçc Sinh">
            <input id="u-class" class="inp" placeholder="L·ªõp (VD: 12A1)" value="12Demo">
            <button class="btn" onclick="saveUserInfo()">L∆∞u & B·∫Øt ƒê·∫ßu</button>
        </div>
    </div>

    <div id="main-app">
        <header>
            <strong style="font-size:1.3rem;color:var(--p)">Mathpro <span style="font-size:0.7rem; color:white; background:var(--ai); padding:2px 5px; border-radius:4px; vertical-align:middle">AI ‚ú®</span></strong>
            <div>
                <span id="u-name-display" style="font-weight:bold;margin-right:10px">H·ªçc sinh</span>
                <button class="nav-btn" onclick="nav('profile')" style="background:#e0f2fe; color:var(--p); margin-right:5px">üë§ C√° nh√¢n</button>
                <button class="nav-btn" style="background:#fee2e2;color:red" onclick="doLogout()">Tho√°t</button>
            </div>
        </header>

        <div class="nav-bar">
            <button class="nav-btn active" onclick="nav('lecture')">B√†i Gi·∫£ng</button>
            <button class="nav-btn" onclick="nav('docs')">T√†i Li·ªáu</button>
            <button class="nav-btn" onclick="nav('quiz')">Luy·ªán Thi</button>
        </div>

        <div class="container">
            <!-- PH·∫¶N B√ÄI GI·∫¢NG -->
            <div id="sec-lecture" class="section active">
                <div class="card" style="height:100%; box-sizing:border-box; display:flex; flex-direction:column; background:white; padding:15px; border-radius:12px;">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">üì∫ Kho B√†i Gi·∫£ng (Demo)</h3>
                    <div class="lecture-layout">
                        <div class="lecture-list" id="lecture-list"></div>
                        <div class="lecture-viewer" id="lecture-viewer">
                            <iframe id="main-frame" class="lecture-iframe" src="" allowfullscreen></iframe>
                            <div id="viewer-placeholder" class="lecture-placeholder" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:white;">
                                <div style="font-size:3rem;">‚ñ∂Ô∏è</div><p>Ch·ªçn b√†i gi·∫£ng ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                            </div>
                            <button id="fullscreen-btn" onclick="toggleFullscreen()">‚õ∂ Ph√≥ng to</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PH·∫¶N T√ÄI LI·ªÜU -->
            <div id="sec-docs" class="section">
                <div class="profile-card">
                    <h3 style="margin-top:0">üìÇ Kho PDF (Demo)</h3>
                                       
                    <div style="padding:10px; background:#fdf2f8; border-left:4px solid #db2777; border-radius:4px; margin-top:10px;">
                        <div style="margin-bottom:5px"><b>üìÑ ƒê·ªÅ 1: Gi·ªØa HK1 (Tham kh·∫£o).pdf</b></div>
                        <div style="display:flex; gap:10px;">
                            <button class="nav-btn" style="padding:5px 15px; background:white; border:1px solid #db2777; color:#db2777; font-size:0.8rem" onclick="viewPDF('ƒê·ªÄ 1 - GI·ªÆA HK1')">üëÅÔ∏è Xem ngay</button>
                            <span style="color:#666;font-size:0.8rem; align-self:center;">(M√¥ ph·ªèng)</span>
                        </div>
                    </div>

                     <div style="padding:10px; background:#fdf2f8; border-left:4px solid #db2777; border-radius:4px; margin-top:10px;">
                        <div style="margin-bottom:5px"><b>üìÑ ƒê·ªÅ 2: Gi·ªØa HK1 (Tham kh·∫£o).pdf</b></div>
                        <div style="display:flex; gap:10px;">
                            <button class="nav-btn" style="padding:5px 15px; background:white; border:1px solid #db2777; color:#db2777; font-size:0.8rem" onclick="viewPDF('ƒê·ªÄ 2 - GI·ªÆA HK1')">üëÅÔ∏è Xem ngay</button>
                        </div>
                    </div>
                </div>
                
                <div class="doc-section">
                    <div class="doc-header">üñºÔ∏è G√≥c Infographic (Demo)</div>
                    <div class="chapter-title" onclick="toggleInfo('c1')">üìö Ch∆∞∆°ng 1: ·ª®ng d·ª•ng ƒë·∫°o h√†m <span style="font-size:0.8em">‚ñº</span></div>
                    <div class="info-grid show" id="info-c1"></div>
                    <div class="chapter-title" onclick="toggleInfo('c3')">üìö Ch∆∞∆°ng 3: Th·ªëng k√™ <span style="font-size:0.8em">‚ñº</span></div>
                    <div class="info-grid" id="info-c3"></div>
                </div>
            </div>

            <!-- PH·∫¶N THI -->
            <div id="sec-quiz" class="section" style="flex-direction:column">
                <div class="quiz-layout">
                    <div class="quiz-main">
                        <div class="paper-header">
                            <div class="paper-info">
                                <div><b>H·ªç t√™n:</b> <span id="q-name">...</span></div>
                                <div><b>L·ªõp:</b> <span id="q-class">...</span></div>
                            </div>
                            <div class="status-box">
                                <div style="font-size:0.9rem; color:#666; margin-bottom:5px;">Th·ªùi gian l√†m b√†i</div>
                                <div id="timer-box">00:00:00</div>
                                <div style="color:red; font-weight:bold; font-size:0.9rem" id="exam-status">ƒêANG L√ÄM B√ÄI</div>
                            </div>
                        </div>
                        <div id="quiz-area" style="flex:1; display:flex; flex-direction:column; justify-content:center;"></div>
                    </div>
                    <div class="quiz-sidebar">
                        <h4 style="margin-top:0; border-bottom:2px solid #eab308; padding-bottom:5px;">üèÜ B·∫£ng V√†ng (Gi·∫£ l·∫≠p)</h4>
                        <ul class="top-list" id="top-list">
                             <li class="top-item"><div style="flex:1"><span class="top-rank top-1">ü•á</span> Nguy·ªÖn VƒÉn A (12A1)</div><div style="text-align:right"><span style="font-weight:bold;color:var(--p)">10.0</span></div></li>
                             <li class="top-item"><div style="flex:1"><span class="top-rank top-2">ü•à</span> Tr·∫ßn Th·ªã B (12A2)</div><div style="text-align:right"><span style="font-weight:bold;color:var(--p)">9.75</span></div></li>
                             <li class="top-item"><div style="flex:1"><span class="top-rank top-3">ü•â</span> L√™ VƒÉn C (12A1)</div><div style="text-align:right"><span style="font-weight:bold;color:var(--p)">9.50</span></div></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- PH·∫¶N C√Å NH√ÇN -->
            <div id="sec-profile" class="section">
                <div class="profile-card">
                    <h3>üë§ Th√¥ng Tin C√° Nh√¢n</h3>
                    <p><b>H·ªç t√™n:</b> <span id="p-fullname">...</span></p>
                    <p><b>L·ªõp:</b> <span id="p-class">...</span></p>
                    <p><b>Email:</b> <span id="p-email">...</span></p>
                </div>
                <div class="profile-card">
                    <h3>üïí L·ªãch S·ª≠ L√†m B√†i</h3>
                    <div id="history-list"><p style="color:#666">Ch∆∞a c√≥ b√†i thi n√†o.</p></div>
                    <button class="btn" style="background:#666; width:auto; margin-top:10px" onclick="clearHistory()">X√≥a l·ªãch s·ª≠</button>
                </div>
            </div>
        </div>

        <!-- FOOTER NAV CHO B√ÄI THI -->
        <div id="footer-nav" class="footer-nav" style="display:none">
            <button class="nav-btn" onclick="moveQ(-1)">‚¨ÖÔ∏è Tr∆∞·ªõc</button>
            <button class="nav-btn" style="border:1px solid var(--p); background:white; color:var(--p)" onclick="toggleGrid()">üî¢ Danh s√°ch</button>
            <button class="nav-btn" onclick="moveQ(1)">Sau ‚û°Ô∏è</button>
            <button class="nav-btn" style="background:var(--danger); color:white" onclick="submitExam()" id="submit-btn">N·ªòP B√ÄI</button>
        </div>
        
        <div id="grid-panel">
            <div class="grid-sec-title">PH·∫¶N I (12 C√¢u)</div> <div class="grid-row" id="grid-p1"></div>
            <div class="grid-sec-title">PH·∫¶N II (2 C√¢u)</div> <div class="grid-row" id="grid-p2"></div>
            <div class="grid-sec-title">PH·∫¶N III (4 C√¢u)</div> <div class="grid-row" id="grid-p3"></div>
        </div>
    </div>

    <!-- LIGHTBOX & PDF PREVIEW -->
    <div id="lightbox" onclick="this.style.display='none'">
        <span style="color:white; font-size:40px; position:absolute; top:20px; right:30px; cursor:pointer">√ó</span>
        <img id="lightbox-img" src="">
        <div id="lightbox-caption" style="color:white; margin-top:15px; font-weight:bold"></div>
    </div>
    <div id="pdf-modal">
        <div class="pdf-container">
            <div class="pdf-header">
                <span id="pdf-title">T√†i li·ªáu</span>
                <button onclick="document.getElementById('pdf-modal').style.display='none'" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#ef4444">√ó</button>
            </div>
            <iframe id="pdf-frame" class="pdf-frame" src=""></iframe>
        </div>
    </div>

    <!-- CHATBOT -->
    <div class="chat-btn" onclick="toggleChat()">‚ú®</div>
    <div class="chat-box" id="chat-box">
        <div style="padding:10px;background:linear-gradient(135deg, var(--p), var(--ai));color:white;font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
            <span>Tr·ª£ l√Ω To√°n H·ªçc AI</span>
            <div style="display:flex;align-items:center;gap:10px">
                <span title="L√†m m·ªõi cu·ªôc tr√≤ chuy·ªán" onclick="clearChatHistory()" style="cursor:pointer; font-size:1rem;">üîÑ</span>
                <span onclick="toggleChat()" style="cursor:pointer; font-size:1.2rem;">√ó</span>
            </div>
        </div>
        <div style="flex:1;padding:10px;overflow-y:auto;background:#f9f9f9" id="chat-msgs">
            <div class="msg bot" style="background:#f3f4f6; padding:8px 12px; margin-bottom:10px; border-radius:12px 12px 12px 0; max-width:85%;">Ch√†o em! C√¥ l√† tr·ª£ l√Ω AI. C√¥ c√≥ th·ªÉ gi·∫£i th√≠ch b√†i to√°n ho·∫∑c gi√∫p em √¥n t·∫≠p. Em c·∫ßn gi√∫p g√¨ kh√¥ng?</div>
        </div>
        
        <!-- File Preview Area -->
        <div id="chat-preview" class="chat-preview-area"></div>
        
        <div style="padding:10px;border-top:1px solid #eee;display:flex">
            <!-- File Input -->
            <input type="file" id="chat-file" style="display:none" accept="image/*,application/pdf" onchange="handleFileSelect(this)">
            <button class="nav-btn" style="margin-right:5px; background:#f3f4f6; color:#666; padding:8px 12px;" onclick="document.getElementById('chat-file').click()">üìé</button>
            
            <input id="chat-inp" class="inp" style="margin:0;flex:1" placeholder="Nh·∫≠p c√¢u h·ªèi ho·∫∑c ch·ª•p ·∫£nh..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="nav-btn" style="margin-left:5px; background:var(--p); color:white" onclick="sendChat()">G·ª≠i</button>
        </div>
    </div>

    <script>
        // CONFIG
        const apiKey = ""; // API Key will be injected here
        
        let user, currentQ=0, answers={}, userData={name:"", class:""}, isReviewMode = false;
        let timerInterval;
        let secondsElapsed = 0;
        let QUESTIONS = []; 
        let currentFile = null; // Store base64 file data
        let chatHistory = []; // L·ªãch s·ª≠ tr√≤ chuy·ªán ƒë·ªÉ gi·ªØ ng·ªØ c·∫£nh

        // D·ªÆ LI·ªÜU GI·∫¢ L·∫¨P (MOCK DATA)
        const LECTURES = [
            { id: 1, title: "B√†i 1: T√≠nh ƒë∆°n ƒëi·ªáu h√†m s·ªë", url: "data:text/html;charset=utf-8," + encodeURIComponent("<body style='background:#000;color:white;display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><h2>üì∫ Video B√†i 1: T√≠nh ƒë∆°n ƒëi·ªáu</h2><p>(M√¥ ph·ªèng tr√¨nh ph√°t video)</p></body>") },
            { id: 2, title: "B√†i 2: C·ª±c tr·ªã h√†m s·ªë", url: "data:text/html;charset=utf-8," + encodeURIComponent("<body style='background:#000;color:white;display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><h2>üì∫ Video B√†i 2: C·ª±c tr·ªã</h2></body>") },
            { id: 3, title: "B√†i 3: GTLN - GTNN", url: "data:text/html;charset=utf-8," + encodeURIComponent("<body style='background:#000;color:white;display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><h2>üì∫ Video B√†i 3: GTLN - GTNN</h2></body>") },
            { id: 4, title: "B√†i 4: ƒê∆∞·ªùng Ti·ªám C·∫≠n", url: "data:text/html;charset=utf-8," + encodeURIComponent("<body style='background:#000;color:white;display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;'><h2>üì∫ Video B√†i 4: Ti·ªám C·∫≠n</h2></body>") }
        ];
        
        // Placeholder images
        const PLACEHOLDER_IMG = "https://via.placeholder.com/300x150?text=S∆°+ƒê·ªì+T∆∞+Duy";
        
        const INFO_DATA = {
            c1: [
                { title: "S∆° ƒë·ªì: T√≠nh ƒë∆°n ƒëi·ªáu", src: PLACEHOLDER_IMG }, 
                { title: "S∆° ƒë·ªì: C·ª±c tr·ªã h√†m s·ªë", src: PLACEHOLDER_IMG },
                { title: "S∆° ƒë·ªì: GTLN - GTNN", src: PLACEHOLDER_IMG }
            ],
            c3: [
                { title: "S∆° ƒë·ªì: Kho·∫£ng Bi·∫øn thi√™n", src: PLACEHOLDER_IMG }, 
                { title: "S∆° ƒë·ªì: Ph√¢n b·ªë t·∫ßn s·ªë", src: PLACEHOLDER_IMG }
            ]
        };

        const MASTER_DATA = [
            {type:1, id:1, q:`Cho t·ª© di·ªán ABCD, g·ªçi I, J l·∫ßn l∆∞·ª£t l√† trung ƒëi·ªÉm c·ªßa AB v√† CD. ƒê·∫≥ng th·ª©c n√†o sau ƒë√¢y ƒë√∫ng?`, opts:["A. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{AC}+\\vec{CD})\\)", "B. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{DC}+\\vec{AD}+\\vec{BD})\\)", "C. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{AD}+\\vec{DC})\\)", "D. \\(\\vec{IJ}=\\frac{1}{2}(\\vec{AC}+\\vec{CB})\\)"], a:"B", explain:"I l√† trung ƒëi·ªÉm AB, J l√† trung ƒëi·ªÉm CD.<br>Ta c√≥ $\\vec{IJ} = \\frac{1}{2}(\\vec{AC}+\\vec{BD})$ l√† ƒê√öNG.<br>C√¥ng th·ª©c ƒë√∫ng l√† B."},
            {type:1, id:2, q:`H√†m s·ªë n√†o d∆∞·ªõi ƒë√¢y ƒë·ªìng bi·∫øn tr√™n kho·∫£ng (-1; 1)?`, opts:["A. y = x - 1", "B. y = x^3", "C. y = -x", "D. y = x^2"], a:"B", explain:"H√†m s·ªë y=x^3 c√≥ ƒë·∫°o h√†m y'=3x^2 >= 0 v·ªõi m·ªçi x, n√™n ƒë·ªìng bi·∫øn tr√™n R."},
            {type:1, id:3, q:"Cho h√†m s·ªë \\(y=\\frac{x-1}{x+1}\\). Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y ƒë√∫ng?", opts:["A. ƒê·ªìng bi·∫øn tr√™n R\\{-1}", "B. Ngh·ªãch bi·∫øn tr√™n R\\{-1}", "C. ƒê·ªìng bi·∫øn (-‚àû;-1)U(-1;+‚àû)", "D. ƒê·ªìng bi·∫øn t·ª´ng kho·∫£ng"], a:"D", explain:"ƒê·∫°o h√†m $y' = \\frac{2}{(x+1)^2} > 0$. H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n t·ª´ng kho·∫£ng x√°c ƒë·ªãnh."},
            {type:1, id:4, q:"H√†m s·ªë \\(y=\\ln(4-x^2)\\) ƒë·ªìng bi·∫øn tr√™n kho·∫£ng?", opts:["A. (-2; 2)", "B. (-2; 0)", "C. (0; 2)", "D. (-‚àû; 2)"], a:"B", explain:"T·∫≠p x√°c ƒë·ªãnh (-2; 2). $y' = \\frac{-2x}{4-x^2}$. $y' > 0 \\Leftrightarrow -2x > 0 \\Leftrightarrow x < 0$. K·∫øt h·ª£p TXƒê: (-2; 0)."},
            {type:1, id:5, q:`Cho h√†m s·ªë y=f(x) c√≥ b·∫£ng bi·∫øn thi√™n. H√†m s·ªë ƒë·∫°t c·ª±c ƒë·∫°i t·∫°i x b·∫±ng bao nhi√™u n·∫øu y' ƒë·ªïi d·∫•u t·ª´ d∆∞∆°ng sang √¢m t·∫°i x=2?`, opts:["A. 2", "B. 0", "C. -2", "D. 1"], a:"A", explain:"D·∫•u hi·ªáu c·ª±c ƒë·∫°i: ƒê·∫°o h√†m ƒë·ªïi d·∫•u t·ª´ d∆∞∆°ng sang √¢m."},
            {type:2, id:13, q:"Trong kh√¥ng gian, cho hai vect∆° a v√† b c√πng c√≥ ƒë·ªô d√†i b·∫±ng 1, g√≥c 45 ƒë·ªô.", subs:["a) \\(\\vec{a}.\\vec{b}=\\frac{\\sqrt{2}}{2}\\).", "b) \\(|\\vec{a}+\\vec{b}|=2+\\sqrt{2}\\).", "c) \\((\\vec{a}+3\\vec{b}).(\\vec{a}-2\\vec{b})=-5+\\frac{\\sqrt{2}}{2}\\).", "d) \\(|\\vec{a}-\\sqrt{2}\\vec{b}|=0\\)."], ans:["S","S","ƒê","ƒê"], explain:"S·ª≠ d·ª•ng c√¥ng th·ª©c t√≠ch v√¥ h∆∞·ªõng: $\\vec{u}.\\vec{v} = |u|.|v|.cos(\\alpha)$."},
            {type:3, id:15, q:`H·∫±ng ng√†y m·ª±c n∆∞·ªõc c·ªßa m·ªôt con k√™nh l√™n xu·ªëng theo th·ªßy tri·ªÅu. ƒê·ªô s√¢u h (m) t√≠nh theo c√¥ng th·ª©c \\(h=2\\cos(\\frac{\\pi t}{12}+\\frac{\\pi}{3})+5\\). G·ªçi (a;b) l√† kho·∫£ng th·ªùi gian trong ng√†y m√† ƒë·ªô s√¢u tƒÉng d·∫ßn. T√≠nh \\(a+b\\).`, a:"28", explain:"<b>B∆∞·ªõc 1:</b> T√≠nh ƒë·∫°o h√†m h'(t).<br> $h'(t) = -2.\\frac{\\pi}{12}sin(\\frac{\\pi t}{12}+\\frac{\\pi}{3})$. <br><b>B∆∞·ªõc 2:</b> ƒê·ªÉ m·ª±c n∆∞·ªõc tƒÉng th√¨ h'(t) > 0.<br>Gi·∫£i b·∫•t ph∆∞∆°ng tr√¨nh l∆∞·ª£ng gi√°c: $sin(\\frac{\\pi t}{12}+\\frac{\\pi}{3}) < 0$.<br><b>B∆∞·ªõc 3:</b> T√¨m kho·∫£ng (a;b) th·ªèa m√£n 0 <= t <= 24. <br>K·∫øt qu·∫£: a=8, b=20 => a+b=28."},
            {type:3, id:16, q:`T√¨m gi√° tr·ªã l·ªõn nh·∫•t c·ªßa h√†m s·ªë \\(y = -x^4 + 2x^2 + 1\\).`, a:"2", explain:"ƒê·∫∑t t=x^2 (t>=0). y = -t^2 + 2t + 1. ƒê·ªânh parabol t=1. Thay v√†o y = 2."}
        ];

        // --- AUTH SIMULATION ---
        function switchTab(t){
            document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.f-view').forEach(f=>f.classList.remove('active'));
            if(t==='login'){document.querySelectorAll('.tab')[0].classList.add('active');document.getElementById('v-login').classList.add('active')}
            else{document.querySelectorAll('.tab')[1].classList.add('active');document.getElementById('v-reg').classList.add('active')}
        }

        // Fake Login function for Demo
        function doFakeLogin() {
            // Create a fake user object
            const fakeUser = {
                uid: 'demo_user_123',
                email: document.getElementById('l-email').value || 'demo@mathpro.edu.vn',
                displayName: 'H·ªçc Sinh Demo'
            };
            
            user = fakeUser;
            document.getElementById('auth-overlay').style.display='none';
            
            // Check if we have saved info for this fake user in LocalStorage
            checkUserInfo(fakeUser);
        }

        function doLogout(){
            location.reload();
        }

        function checkUserInfo(u) {
            const stored = localStorage.getItem('user_demo'); // Always use 'user_demo' key for simplicity
            if(stored) {
                userData = JSON.parse(stored);
                updateProfileUI();
                document.getElementById('main-app').style.display='flex';
                initLectures(); initInfographics();
                loadHistory();
            } else {
                document.getElementById('info-modal').style.display='flex';
            }
        }

        function saveUserInfo() {
            let name = document.getElementById('u-fullname').value;
            let cls = document.getElementById('u-class').value;
            if(!name || !cls) { alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß H·ªç t√™n v√† L·ªõp!"); return; }
            userData = { name: name, class: cls };
            localStorage.setItem('user_demo', JSON.stringify(userData));
            document.getElementById('info-modal').style.display='none';
            document.getElementById('main-app').style.display='flex';
            updateProfileUI(); 
            initLectures(); initInfographics();
            loadHistory();
        }

        function updateProfileUI() {
            document.getElementById('u-name-display').innerText = userData.name;
            document.getElementById('p-fullname').innerText = userData.name;
            document.getElementById('p-class').innerText = userData.class;
            document.getElementById('q-name').innerText = userData.name;
            document.getElementById('q-class').innerText = userData.class;
            document.getElementById('p-email').innerText = user.email;
        }

        // --- APP LOGIC ---
        function startTimer() {
            clearInterval(timerInterval); secondsElapsed = 0; updateTimerDisplay();
            timerInterval = setInterval(() => { secondsElapsed++; updateTimerDisplay(); }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); }
        function updateTimerDisplay() {
            const h = Math.floor(secondsElapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((secondsElapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (secondsElapsed % 60).toString().padStart(2, '0');
            document.getElementById('timer-box').innerText = `${h}:${m}:${s}`;
        }
        function getDurationText() {
            const h = Math.floor(secondsElapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((secondsElapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (secondsElapsed % 60).toString().padStart(2, '0');
            return `${h}h ${m}p ${s}s`; 
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function nav(id){
            if(id !== 'lecture') {
                const iframe = document.getElementById('main-frame');
                if(iframe) { iframe.src = ""; iframe.style.display = 'none'; }
                const place = document.getElementById('viewer-placeholder');
                if(place) place.style.display = 'flex';
                document.getElementById('fullscreen-btn').style.display='none';
                document.querySelectorAll('.lecture-item').forEach(el => el.classList.remove('active'));
            }

            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            const qs = document.getElementById('sec-quiz');
            
            if(id === 'quiz') {
                isReviewMode = false; answers = {};
                // Reset and Shuffle Questions
                let p1 = MASTER_DATA.filter(q => q.type === 1).slice(); 
                let p2 = MASTER_DATA.filter(q => q.type === 2).slice();
                let p3 = MASTER_DATA.filter(q => q.type === 3).slice();
                shuffleArray(p1); shuffleArray(p2); shuffleArray(p3);
                QUESTIONS = [...p1, ...p2, ...p3];
                
                document.getElementById('exam-status').innerText = "ƒêANG L√ÄM B√ÄI";
                document.getElementById('exam-status').style.color = "red";
                document.getElementById('submit-btn').style.display = "block";
                qs.classList.add('active'); qs.style.display='flex';
                document.getElementById('footer-nav').style.display='flex';
                currentQ = 0; startTimer(); renderQ();
            } else {
                stopTimer();
                qs.classList.remove('active'); qs.style.display='none';
                document.getElementById('sec-'+id).classList.add('active');
                document.getElementById('footer-nav').style.display='none';
            }
            const map = {'lecture':0, 'docs':1, 'quiz':2};
            if(map[id]!==undefined) document.querySelectorAll('.nav-bar .nav-btn')[map[id]].classList.add('active');
        }

        function viewPDF(title) {
            document.getElementById('pdf-title').innerText = title;
            // Fake PDF viewer using a data URI
            const fakePdfContent = `<body style='font-family:sans-serif; text-align:center; padding:50px; background:#eee;'>
                <h1>üìÑ ${title}</h1>
                <p>ƒê√¢y l√† tr√¨nh xem tr∆∞·ªõc gi·∫£ l·∫≠p.</p>
                <div style='border:1px solid #ccc; background:white; height:400px; display:flex; align-items:center; justify-content:center;'>
                    N·ªôi dung PDF s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.
                </div>
            </body>`;
            document.getElementById('pdf-frame').src = "data:text/html;charset=utf-8," + encodeURIComponent(fakePdfContent);
            document.getElementById('pdf-modal').style.display = 'flex';
        }

        function initLectures() {
            const list = document.getElementById('lecture-list'); if(!list) return;
            list.innerHTML = LECTURES.map((lec,i) => `<div class="lecture-item" onclick="playLecture(${i})" id="lec-btn-${i}"><span>üì∫</span> ${lec.title}</div>`).join('');
        }
        function playLecture(i) {
            document.querySelectorAll('.lecture-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`lec-btn-${i}`).classList.add('active');
            document.getElementById('viewer-placeholder').style.display = 'none';
            document.getElementById('main-frame').style.display = 'block';
            document.getElementById('main-frame').src = LECTURES[i].url;
            document.getElementById('fullscreen-btn').style.display = 'block';
        }

        function toggleFullscreen() {
            const viewer = document.getElementById('lecture-viewer');
            if(!viewer.classList.contains('fullscreen')) {
                viewer.classList.add('fullscreen');
                document.getElementById('fullscreen-btn').innerText = 'Thu nh·ªè';
            } else {
                viewer.classList.remove('fullscreen');
                document.getElementById('fullscreen-btn').innerText = '‚õ∂ Ph√≥ng to';
            }
        }

        function initInfographics() {
            ['c1', 'c3'].forEach(id => {
                const list = document.getElementById('info-'+id); if(!list) return;
                list.innerHTML = INFO_DATA[id].map(inf => `<div class="info-card" onclick="openLightbox('${inf.src}', '${inf.title}')"><span style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.6);color:white;padding:2px 5px;border-radius:4px;font-size:0.8rem">Xem</span><img src="${inf.src}" class="info-img"><div class="info-title">${inf.title}</div></div>`).join('');
            });
        }
        function toggleInfo(id) { document.getElementById('info-'+id).classList.toggle('show'); }
        function openLightbox(s,t) { document.getElementById('lightbox-img').src=s; document.getElementById('lightbox-caption').innerText=t; document.getElementById('lightbox').style.display='flex'; }

        // --- RENDER C√ÇU H·ªéI ---
        function renderQ() {
            const q = QUESTIONS[currentQ];
            let html = `<div class="q-card"><div><span class="part-label">Ph·∫ßn ${q.type} - C√¢u ${currentQ + 1}</span></div><div class="q-content">${q.q}</div>`;
            
            if(q.type===1) {
                html+=`<div class="opt-list">`+q.opts.map(o=>{
                    let val = o.charAt(0);
                    let cls = isReviewMode ? (answers[q.id]===val ? (val===q.a ? 'review-correct' : 'review-wrong') : (val===q.a ? 'review-correct' : '')) : (answers[q.id]===val ? 'selected' : '');
                    return `<div class="opt-item ${cls}" onclick="${isReviewMode?'':'saveAns('+q.id+',\''+val+'\')'}">${o}</div>`;
                }).join('')+`</div>`;
            } else if(q.type===2) {
                html+=`<table class="tf-table">`+q.subs.map((s,i)=>{
                    let k = q.id+'_'+i;
                    let uAns = answers[k]; let rAns = q.ans[i];
                    let dCls = isReviewMode ? (uAns==='ƒê'?(rAns==='ƒê'?'review-correct':'review-wrong'):(rAns==='ƒê'?'review-correct':'')) : (uAns==='ƒê'?'selected':'');
                    let sCls = isReviewMode ? (uAns==='S'?(rAns==='S'?'review-correct':'review-wrong'):(rAns==='S'?'review-correct':'')) : (uAns==='S'?'selected':'');
                    return `<tr><td>${s}</td><td style="white-space:nowrap"><span class="tf-btn ${dCls}" onclick="${isReviewMode?'':'saveAns(\''+k+'\',\'ƒê\')'}">ƒê√∫ng</span><span class="tf-btn ${sCls}" onclick="${isReviewMode?'':'saveAns(\''+k+'\',\'S\')'}">Sai</span></td></tr>`;
                }).join('')+`</table>`;
            } else {
                let uVal = answers[q.id]||'';
                let style = isReviewMode ? (uVal.trim()===q.a ? 'border-color:#22c55e;color:#15803d' : 'border-color:#ef4444;color:#b91c1c') : '';
                html+=`<input class="short-inp" value="${uVal}" style="${style}" oninput="saveAns(${q.id},this.value)" ${isReviewMode?'readonly':''} placeholder="Nh·∫≠p ƒë√°p √°n...">`;
            }

            html += `<div class="hint-toggle-btn" onclick="toggleHint()">üí° Xem g·ª£i √Ω / L·ªùi gi·∫£i</div>`;
            let explainText = q.explain ? q.explain : "C√¢u n√†y ch∆∞a c√≥ l·ªùi gi·∫£i chi ti·∫øt.";
            html += `<div id="q-hint" class="hint-box">
                <button class="ai-btn" onclick="getAIExplanation(${q.id})">‚ú® Gi·∫£i th√≠ch chi ti·∫øt b·∫±ng AI</button>
                <br><br>
                <b>üìù H∆∞·ªõng d·∫´n:</b><br>${explainText}
                <div id="ai-explain-${q.id}" style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px; display:none; color:#1f2937"></div>
            </div>`;

            html+=`</div>`;
            document.getElementById('quiz-area').innerHTML=html;
            if(window.MathJax) MathJax.typesetPromise();
            updateGrid();
        }

        function toggleHint() {
            const box = document.getElementById('q-hint');
            if (box.style.display === 'block') {
                box.style.display = 'none';
            } else {
                box.style.display = 'block';
                if(window.MathJax) MathJax.typesetPromise([box]);
            }
        }

        function saveAns(k,v){if(!isReviewMode){answers[k]=v;renderQ();}}
        function moveQ(d){const n=currentQ+d;if(n>=0&&n<QUESTIONS.length){currentQ=n;renderQ();}}
        function toggleGrid(){const p=document.getElementById('grid-panel');p.style.display=p.style.display==='block'?'none':'block';}
        function updateGrid(){
            const p1=QUESTIONS.map((q,i)=>renderBtn(q,i)).filter((_,i)=>QUESTIONS[i].type===1).join('');
            const p2=QUESTIONS.map((q,i)=>renderBtn(q,i)).filter((_,i)=>QUESTIONS[i].type===2).join('');
            const p3=QUESTIONS.map((q,i)=>renderBtn(q,i)).filter((_,i)=>QUESTIONS[i].type===3).join('');
            document.getElementById('grid-p1').innerHTML=p1;
            document.getElementById('grid-p2').innerHTML=p2;
            document.getElementById('grid-p3').innerHTML=p3;
        }
        function renderBtn(q,i){
            let done=false;
            if(q.type===1 && answers[q.id]) done=true;
            if(q.type===3 && answers[q.id]) done=true;
            if(q.type===2) for(let k=0;k<4;k++) if(answers[q.id+'_'+k]) done=true;
            return `<button class="q-btn ${done?'done':''} ${i===currentQ?'current':''}" onclick="currentQ=${i};renderQ();toggleGrid()">${i+1}</button>`;
        }

        function submitExam() {
            if(isReviewMode) return;
            stopTimer();
            const timeString = getDurationText(); 

            let s1=0, s2=0, s3=0;
            QUESTIONS.filter(q=>q.type===1).forEach(q=>{if(answers[q.id]===q.a) s1+=0.25});
            QUESTIONS.filter(q=>q.type===2).forEach(q=>{let c=0; q.ans.forEach((a,i)=>{if(answers[q.id+'_'+i]===a) c++}); s2+=[0,0.1,0.25,1.0,1.5][c]});
            QUESTIONS.filter(q=>q.type===3).forEach(q=>{if(answers[q.id]?.trim()===q.a) s3+=1.0});
            
            const total = (s1+s2+s3).toFixed(2);
            let msg = ""; let t = parseFloat(total);
            if(t < 5) msg = "C·ªë g·∫Øng h∆°n nh√©! ƒê·ª´ng n·∫£n ch√≠!";
            else if(t < 7) msg = "Kh√° t·ªët! H√£y √¥n t·∫≠p th√™m ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm cao h∆°n!";
            else if(t < 9) msg = "Gi·ªèi l·∫Øm! Ch·ªâ c√≤n m·ªôt ch√∫t n·ªØa l√† tuy·ªát ƒë·ªëi!";
            else msg = "Xu·∫•t s·∫Øc! B·∫°n l√† thi√™n t√†i to√°n h·ªçc!";

            document.getElementById('res-score').innerText = total;
            document.getElementById('res-time').innerText = "‚è± " + timeString;
            document.getElementById('res-msg').innerText = msg;
            document.getElementById('result-modal').style.display = 'flex';
            
            saveHistory(total, answers);
        }

        function closeResult() {
            document.getElementById('result-modal').style.display = 'none';
            let history = JSON.parse(localStorage.getItem('his_demo') || "[]");
            let latestIdx = history.length - 1;
            reviewExam(latestIdx);
        }

        function saveHistory(score, userAnswers) {
            let history = JSON.parse(localStorage.getItem('his_demo') || "[]");
            history.push({ date: new Date().toLocaleString(), score: score, answers: JSON.parse(JSON.stringify(userAnswers)) });
            localStorage.setItem('his_demo', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('his_demo') || "[]");
            const list = document.getElementById('history-list');
            if(history.length === 0) {
                 list.innerHTML = '<p style="color:#666">Ch∆∞a c√≥ b√†i thi n√†o.</p>';
                 return;
            }
            let html = '';
            history.slice().reverse().forEach((h, idx) => {
                let realIdx = history.length - 1 - idx;
                let cls = h.score < 5 ? 's-low' : (h.score < 8 ? 's-mid' : 's-high');
                html += `<div class="history-item"><div><span>üìÖ ${h.date}</span></div><div><span class="score-badge ${cls}" style="margin-right:10px">${h.score}ƒë</span><button class="nav-btn" style="padding:5px 10px; font-size:0.8rem" onclick="reviewExam(${realIdx})">Xem l·∫°i</button></div></div>`;
            });
            list.innerHTML = html;
        }

        function clearHistory() {
            if(confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠?')) {
                localStorage.removeItem('his_demo');
                loadHistory();
            }
        }
        
        function reviewExam(index) {
            let history = JSON.parse(localStorage.getItem('his_demo') || "[]");
            let item = history[index];
            if(!item) return;
            
            isReviewMode = true; 
            answers = item.answers || {};
            
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            document.getElementById('sec-quiz').classList.add('active');
            document.getElementById('sec-quiz').style.display='flex';
            document.getElementById('footer-nav').style.display='flex';
            document.getElementById('exam-status').innerText = "ƒêANG XEM L·∫†I (ƒêi·ªÉm: " + item.score + ")";
            document.getElementById('exam-status').style.color = "blue";
            document.getElementById('timer-box').innerText = "--:--:--"; 
            document.getElementById('submit-btn').style.display = "none";
            currentQ = 0; renderQ();
        }

        function toggleChat(){const b=document.getElementById('chat-box');b.style.display=b.style.display==='flex'?'none':'flex'}
        
        // --- FILE HANDLING ---
        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // Simple validation for Word docs (warn user)
            if(file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                alert("L∆∞u √Ω: H·ªá th·ªëng hi·ªán t·∫°i h·ªó tr·ª£ t·ªët nh·∫•t cho t·ªáp ·∫¢NH v√† PDF. T·ªáp Word c√≥ th·ªÉ kh√¥ng hi·ªÉn th·ªã ƒë√∫ng.");
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result.split(',')[1];
                currentFile = {
                    inlineData: {
                        mimeType: file.type,
                        data: base64Data
                    }
                };
                
                // Show preview
                const previewArea = document.getElementById('chat-preview');
                previewArea.style.display = 'flex';
                let icon = 'üìÑ';
                if(file.type.startsWith('image/')) icon = `<img src="${e.target.result}" class="preview-thumb">`;
                
                previewArea.innerHTML = `
                    <div class="chat-file-preview">
                        ${icon} ${file.name} 
                        <span style="cursor:pointer;margin-left:5px;color:#ef4444" onclick="clearFile()">√ó</span>
                    </div>`;
            };
            reader.readAsDataURL(file);
        }

        function clearFile() {
            currentFile = null;
            document.getElementById('chat-file').value = '';
            document.getElementById('chat-preview').style.display = 'none';
            document.getElementById('chat-preview').innerHTML = '';
        }

        function clearChatHistory() {
            chatHistory = [];
            document.getElementById('chat-msgs').innerHTML = '<div class="msg bot" style="background:#f3f4f6; padding:8px 12px; margin-bottom:10px; border-radius:12px 12px 12px 0; max-width:85%;">Ch√†o em! C√¥ l√† tr·ª£ l√Ω AI. C√¥ c√≥ th·ªÉ gi·∫£i th√≠ch b√†i to√°n ho·∫∑c gi√∫p em √¥n t·∫≠p. Em c·∫ßn gi√∫p g√¨ kh√¥ng?</div>';
        }

        // --- GEMINI API INTEGRATION ---

        async function callGeminiAPI(history, systemInstruction = null) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: history
            };
            
            if(systemInstruction) {
                payload.systemInstruction = { parts: [{ text: systemInstruction }] };
            }

            let retries = 0;
            const maxRetries = 3;
            
            while (retries < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    retries++;
                    console.warn(`Gemini API attempt ${retries} failed.`);
                    if (retries === maxRetries) return null;
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, retries)));
                }
            }
        }

        async function sendChat() {
            const input = document.getElementById('chat-inp');
            const text = input.value.trim();
            
            // Allow sending if there is text OR a file
            if (!text && !currentFile) return;

            const chatMsgs = document.getElementById('chat-msgs');
            
            // Display User Message in UI
            let userContent = "";
            if(currentFile) {
                userContent += `<div style="font-size:0.8rem;color:#666;margin-bottom:5px">üìé <i>ƒê√£ g·ª≠i 1 t·ªáp ƒë√≠nh k√®m</i></div>`;
            }
            if(text) userContent += text;

            chatMsgs.innerHTML += `
                <div class="msg user" style="background:#e0f2fe; padding:8px 12px; margin-bottom:10px; border-radius:12px 12px 0 12px; align-self:flex-end; max-width:85%; border: 1px solid #bae6fd; margin-left: auto;">
                    <b>Em:</b><br>${userContent}
                </div>`;
            
            // Construct User Message for History
            const parts = [];
            if (text) parts.push({ text: text });
            if (currentFile) parts.push(currentFile);
            
            // Add to history
            chatHistory.push({ role: "user", parts: parts });
            
            // Clear inputs
            const fileToSend = currentFile; 
            input.value = '';
            clearFile(); 
            
            chatMsgs.scrollTop = chatMsgs.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            chatMsgs.innerHTML += `
                <div id="${loadingId}" class="msg bot" style="background:#f3f4f6; padding:8px 12px; margin-bottom:10px; border-radius:12px 12px 12px 0; color:#6b7280; font-style:italic; max-width:85%;">
                    ƒêang xem x√©t...
                </div>`;
            chatMsgs.scrollTop = chatMsgs.scrollHeight;

            // Updated System Prompt: Socratic Method + Grading Logic
            const systemPrompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω gi√°o vi√™n To√°n h·ªçc th√¢n thi·ªán (x∆∞ng h√¥ C√¥ - Em).
            NHI·ªÜM V·ª§ QUAN TR·ªåNG:
            1. Khi h·ªçc sinh h·ªèi b√†i: TUY·ªÜT ƒê·ªêI KH√îNG ƒë∆∞a ƒë√°p √°n ngay. H√£y ph√¢n t√≠ch ƒë·ªÅ v√† g·ª£i √Ω t·ª´ng b∆∞·ªõc (Socratic method).
            2. Khi h·ªçc sinh tr·∫£ l·ªùi g·ª£i √Ω c·ªßa b·∫°n:
               - N·∫øu ƒê√öNG: H√£y khen ng·ª£i (V√≠ d·ª•: "Ch√≠nh x√°c!", "Gi·ªèi l·∫Øm!"). Sau ƒë√≥ h·ªèi h·ªçc sinh c√≥ mu·ªën ti·∫øp t·ª•c sang b∆∞·ªõc sau ho·∫∑c b√†i ti·∫øp theo kh√¥ng.
               - N·∫øu SAI: H√£y nh·∫π nh√†ng ch·ªâ ra l·ªói sai (V√≠ d·ª•: "G·∫ßn ƒë√∫ng r·ªìi, nh∆∞ng em xem l·∫°i d·∫•u...", "Ch∆∞a ch√≠nh x√°c, em th·ª≠ t√≠nh l·∫°i ch·ªó..."). ƒê∆∞a ra g·ª£i √Ω chi ti·∫øt h∆°n ƒë·ªÉ h·ªçc sinh t·ª± s·ª≠a.
            3. Lu√¥n gi·ªØ th√°i ƒë·ªô ki√™n nh·∫´n, kh√≠ch l·ªá.
            4. S·ª≠ d·ª•ng LaTeX cho c√¥ng th·ª©c to√°n ($...$).`;
            
            const reply = await callGeminiAPI(chatHistory, systemPrompt);
            
            let finalMsg = reply || "Xin l·ªói, hi·ªán t·∫°i c√¥ kh√¥ng th·ªÉ ƒë·ªçc ƒë∆∞·ª£c n·ªôi dung n√†y. Em th·ª≠ l·∫°i nh√©!";
            
            // Add Model Reply to History
            chatHistory.push({ role: "model", parts: [{ text: finalMsg }] });
            
            if(window.marked) {
                finalMsg = marked.parse(finalMsg);
            } else {
                finalMsg = finalMsg.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>").replace(/\n/g, "<br>");
            }

            const el = document.getElementById(loadingId);
            el.innerHTML = `<b>C√¥ gi√°o AI:</b><br>${finalMsg}`;
            el.style.fontStyle = "normal";
            el.style.color = "var(--txt)";
            
            if(window.MathJax) MathJax.typesetPromise([el]);
            chatMsgs.scrollTop = chatMsgs.scrollHeight;
        }

        // Keep the old button for backward compatibility but using new Socratic prompt logic
        async function getAIExplanation(qId) {
            const q = QUESTIONS.find(x => x.id === qId);
            if(!q) return;

            const divId = `ai-explain-${qId}`;
            const div = document.getElementById(divId);
            div.style.display = 'block';
            div.innerHTML = `<span style="color:#6366f1"><i>‚ú® ƒêang nh·ªù AI ph√¢n t√≠ch...</i></span>`;

            // For explicit explanation requests, we create a temporary "mini" history
            // or just a one-off call, but let's keep it simple as one-off for now
            const prompt = `Gi·∫£i th√≠ch chi ti·∫øt c√¢u h·ªèi tr·∫Øc nghi·ªám sau:
            C√¢u h·ªèi: ${q.q}
            C√°c l·ª±a ch·ªçn: ${q.opts ? q.opts.join(', ') : 'T·ª± lu·∫≠n'}
            ƒê√°p √°n ƒë√∫ng: ${q.a}
            H√£y gi·∫£i th√≠ch T·∫†I SAO ƒë√°p √°n ƒë√≥ ƒë√∫ng, ph√¢n t√≠ch l·ªói sai th∆∞·ªùng g·∫∑p ·ªü c√°c ƒë√°p √°n nhi·ªÖu.`;
            
            // Use a temporary history just for this call
            const tempHistory = [{ role: "user", parts: [{ text: prompt }] }];

            const reply = await callGeminiAPI(tempHistory, "B·∫°n l√† chuy√™n gia gi·∫£i th√≠ch b√†i t·∫≠p tr·∫Øc nghi·ªám.");
            
            let finalMsg = reply || "L·ªói k·∫øt n·ªëi.";
            if(window.marked) finalMsg = marked.parse(finalMsg);

            div.innerHTML = `<b>üí° Ph√¢n t√≠ch t·ª´ AI:</b><br>${finalMsg}`;
            if(window.MathJax) MathJax.typesetPromise([div]);
        }

    </script>
</body>
</html>